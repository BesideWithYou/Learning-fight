## 滴滴实习

在滴滴实习做的最大的一个需求以及最有收获的需求就是做了一个流水加速卡的批量配置系统。下面就是记录一下这个系统主要是做了哪些工作。

### 项目描述

这个项目主要是一个运营工作台系统，主要是用来解决用车高峰时车辆调度的问题，比如当早上或者晚上上下班高峰期的时候，某个区域的车辆不够用，那么我们就可以在后台系统去配发这个流水加速卡，这个加速卡是限定时间和范围的，比如说早上8点到9点在北京的某个区域很多人打车，那么我们就可以去配发这个加速卡。流水加速卡可以增加司机额外的收入，让司机更加愿意去某个地方跑单，并且这个流水加速卡是限量的，一般只发给一些记录比较好的司机。然后本来这个系统只能进行一条一条的加速卡配置，全国有375个城市，并且一个城市可能会配发多条加速卡信息，所以说一条一条配置的效率太低，那么就有了批量配置这样的一个需求。我在这次系统中主要就是做的这个批量配置的模块，然后前端这边是我自己一个人独立负责，导师在背后指导。

### 主要逻辑

这个项目的主要逻辑就是做批量配置管理。我们在开发中遇到了一个主要的问题就是，我们上传数据是通过一个上传Excel表格的入口，然后上传这个表格之后后端会返回一个对应的id。后端会需要去对这个表格中的每一个单元格里的数据做格式校验，如果校验不通过那么后端就会返回对应的状态码并且返回对应的报错信息，我们在前端页面就给用户做提示让用户去修改那个对应的单元格之后再重新去做数据的提交。另外当数据量较大的时候后端就需要去对这些数据进行比较长的时间校验，比如说有300条数据，那么可能后端就要去校验20秒左右，一开始我们是通过同步上传的形式去做校验的，然后我们的node中间层就会报超时的问题，因为node中间层对接口做了10秒钟的超时处理，我们直接去改node中间层也不太现实，因为可能会影响到使用到这个中间层的其它模块，所以通过和后端同学进行商量后，我们决定把这个同步上传的方式改成异步上传。就是首次上传之后后端返回一个异步提交中的状态码和这个文件的id，然后我们就不断去发起后续请求拿这个id去轮询接口，后端会返回对应的状态码信息，比如说1是异步提交中，2是校验失败，3是提交成功，直到我们提交成功的时候就去终止轮询，或者后端返回校验失败的时候我们就在页面让用户去做对应的数据修改再进行重新提交。轮询这把我们是通过setTimeout的方式去做提交的（一开始对比过setInterval和setTimeout的两种方式，但是setInterval会存在一个问题，比如说我们在setInterval执行的过程中有很多其它的UI操作，这时候任务队列里setInterval的回调函数执行可能就不准时，最后可能就会导致在某个时间节点同时执行大量的回调函数，所以我们就采用了setTimeout的方式去解决，因为setTimeout可以在执行完上一个回调之后再去开启下一个回调的执行，这样就比较好的解决了轮询的问题）。

另外存在的一个类似的问题也是这样的，比如说我们的流水加速卡的生效时间必须要在当前时间之后。假如现在是5点，用户设置了流水加速卡生效时间为5点01分，但是直到5点02分才去上传，这时候逻辑肯定是不对的，所以我们的异步数据校验也比较好的解决了这个问题，检测到这里数据有错误，后端就会抛出对应单元格的错误给我们，然后让用户去做相应的修改。

### 收获

通过这个项目，经历了一次从需求评审到开发到上线的完整流程，比较大的提高了沟通能力和团队协作能力。然后项目的结果就是从原有的60个左右的运营管理人员减少到了现在的20个左右，较大的提高了运营管理效率。

