## 操作系统

### 概念、定义

操作系统是指控制和管理整个计算机系统的硬件和软件资源，并合理地组织调度计算机的工作和资源的分配；以提供给用户和其它软件方便的接口和环境；它是计算机系统中最基本的系统软件。

- 系统资源的管理者
- 向上层提供方便易用的服务
- 最接近硬件的软件

### 功能和目标

#### 资源的管理者

- **处理机管理：**进程控制(创建进程、撤销进程，状态转换)、调度(分为作业调度和进程调度)、进程同步(设置进程同步信息，协调系统进程运行，使多个进程有条不紊运行)、进程通信(进程间信息交换，使得进程间可以相互合作)
- **存储器管理：**地址重定位(逻辑地址到物理地址转换)、存储分配(为程序分配空间和回收内存)、存储保护(保护各个程序之间互不侵犯)、存储扩充(建立虚拟存储系统实现内存逻辑的扩充)
- **文件管理：** 目录管理、文件的读写管理和存取控制、文件存储空间管理、软件管理
- **设备管理： **缓冲管理(I/O缓冲区管理)、设备分配、设备处理、**设备独立性和虚拟设备**
- **用户接口： **命令接口、程序接口、图形接口

#### 向上层提供服务

- 普通用户使用的GUI图形界面、命令接口（联机命令接口、脱机命令接口）
- 程序员使用的程序接口（即系统调用）
- 对硬件机器的扩充

### OS的四个特性

**并发和共享是两个最基本的特性**（互为存在条件）

- **并发：** 指两个或多个事件在**同一时间间隔内(强调时间间隔)**发生。这些事件在宏观上是同时发生的，微观上是交替发生。另一个易混淆的概念是**并行(多个事件同一时刻同时发生-强调时刻)**。 单核CPU同一时刻只能执行一个程序，各个程序只能**并发**执行，多核CPU同一时刻可以同时执行多个程序，多个程序可以**并行**执行。
- **共享： **资源共享，指系统中的资源可供内存中多个并发执行的进程共同使用。又分为**互斥共享方式**(系统某些资源可以供多个**进程（系统中能独立运行并作为资源分配的基本单位，由一组机器指令、数据和堆栈等组成，是一个能独立运行的活动实体）**访问，但是同一个时间段只允许一个进程访问)和**同时共享方式**(系统某些资源允许**同一个时间段**内多个**进程同时(宏观)访问**，**微观仍可能是交替进行访问**)
- **虚拟：** 把一个物理上的实体(实际存在)变成若干个逻辑上的对应物(用户感受上)。虚拟又涉及到空分复用技术(虚拟存储器)和时分复用技术(虚拟处理器-微观上处理机在各个微小时间段内交替为进程服务)
- **异步：** 在多道程序环境下，允许多个进程并发执行，但由于资源有限，进程的执行不是一贯到底的，而是走走停停，以不可预知的速度向前推进。 **只有系统拥有并发性，才可能导致异步性。**(并发的进程会抢占系统资源，但是系统资源有限，所以进程的执行不是一贯到底的，而是走走停停)

### 发展和分类

#### 手工操作阶段

用户独占全机，资源独占导致利用率低，输入输出设备主要是纸带和卡片，CPU会等待用户手工装入纸带或卡片，人工控制程序的执行。CPU等待I/O设备，导致CPU的处理能力浪费。

#### 单道批处理系统

引入了脱机输入/输入技术，计算机上电后运行一个**常驻内存的监控程序**，设立专门操作员，用户将卡带或磁带中的作业交给操作员。操作员将作业分为若干组，称为一批作业，然后安装到输入设备上，监控程序按顺序读入并执行，完成后输出结果并由监控程序自动加载下个作业。**每个作业之间串行执行。**

- **优点：** 缓解了人机速度矛盾，资源利用率有所提升
- **缺点：** 内存中仅有一道程序运行，只有该程序运行结束后才调入下一道程序，CPU大量时间在等待I/O完成，利用率仍然低下。

#### 多道批处理系统

多个作业同时进入主存，将内存分为若干区域，每个分区存放一个用户作业。各作业交替使用CPU，当前作业需要I/O处理时，CPU转去执行另一个作业。**宏观上并发运行，微观上串行运行**。

需要增加的硬件：I/O中断、DMA，需要增加的软件：存储管理、CPU调度、资源竞争控制

- **优点：** 多道程序并发执行，共享计算机资源，资源利用率大幅提高，系统吞吐量大
- **缺点：**用户响应时间长，没有人机交互功能(处理作业时中间不能自己控制作业的执行)，作业平均周转时间长：短作业周转时间显著增长。（周转时间 = 结束时间 - 开始时间）

#### 分时操作系统

计算机以时间片为单位轮流为各个用户/作业服务，各个用户可通过终端与计算机进行交互。如果某作业在分配给它的时间片用完时仍未完成，则该作业就暂时中断，等待下一轮运行，并把处理机的控制权让给另一个作业使用。这样在一个相对较短的时间间隔内，每个用户作业都能得到快速响应，以实现人机交互。

**优点：** 用户请求可以即时响应，解决了人机交互问题。允许多个用户同时使用一台计算机，多个用户对计算机的操作相互独立，缩短了周转时间。

**缺点：** 不能优先处理一些紧急任务，操作系统对每个用户/作业是公平的。

#### 实时操作系统

计算机接到外部信号后能及时处理，并且在严格的时限内处理事件。具有及时性和可靠性，响应时间短。主要功能：实时时钟管理、过载保护、容错能力和冗余备份。

- 硬实时系统：必须在**绝对严格**的规定时间内完成处理（导弹控制、自动驾驶）
- 软实时系统：能接受偶尔违反时间规定（订票系统）

#### 网络操作系统

把网络中的各个计算机有机结合起来，实现数据传送功能，实现网络资源共享和各个计算机之间的通信。

#### 分布式操作系统

具有分布性、并行性、透明性、共享性、健壮性。系统中各台计算机地位相同，大量计算机交织在一起通过网络进行连接。任何工作都可以分布在这些计算机上由它们并行、协同完成任务。在用户眼里就像一台虚拟的单处理机，用户不必关心计算机资源分配和调度问题。

#### 个人操作系统

如我们常见的Windows系统，Mac系统，安卓/IOS。特点：使用方便、响应速度快，支持多种硬件和外部设备，效率不用特别高。

#### 微内核OS结构

能有效支持多处理机运行，非常适合分布式系统。

特点：

- 足够小的内核：微内核并非是一个完整的OS，而是将操作系统最基本的部分放入微内核
- 基于客户/服务器模式：操作系统基本功能放在内核中，绝大部分其它功能放在微内核外的服务器实现
- 应用“机制与策略分离”原理：机制指实现某一功能的具体执行机构，策略指在机制基础上借助某些参数和算法实现优化或达到不同的功能目标。
- 采用面向对象技术：封装、继承、多态。确保操作系统的正确性、可靠性、易修改性、易扩展性。

### 小结

设置操作系统的目的就是提高计算机系统的效率，增强系统的处理能力，充分发挥系统的利用率，方便用户使用。因此现代操作系统普遍采用以多道程序设计为基础的并行操作技术。具有并发性、共享性、虚拟性、异步性。为提高系统资源利用率和对软硬件有效管理，提供处理机管理、存储器管理、设备管理、文件管理、用户接口的功能。并了解到各个阶段的操作系统的特点。

## 进程、线程

### 前趋图

 前趋图是为了描述一个程序的各部分间的依赖关系，或者是一个大的计算的各个子任务间的因果关系的图示。 **前趋图中必须不存在循环（有向无环）** 。前趋图中的每个结点可以表示一条语句、一个程序段或一个进程，结点间的有向边表示两个结点之间存在的偏序或前趋关系。

### 程序顺序执行

一个应用程序由若干个程序段组成，每一个程序段完成特定功能，在执行时，都需要按照某种先后次序顺序执行，仅当前一段程序段执行完后，才运行后一段程序段。类似于下方：

```
S1: a:= x + y
S2: b:= a - 5
S3: c:= b + 1

S2必须在语句S1后执行，S3必须在语句S2后执行，即：S1→S2→S3
```

### 程序顺序执行的特征

程序顺序执行时具有下面三个特征：

- **顺序性：**处理机严格按照程序规定的顺序执行，即每一操作必须在下一个操作开始之前结束
- **封闭性：**程序在封闭环境下执行，即程序运行时独占全机资源，程序执行时，执行结果不受外界影响。
- **可再现性：**只要程序执行时的环境和初始条件相同，当程序重复执行时，不论它是从头到尾执行完还是走走停停执行，都能获得相同结果。

这些特性为调试、检测校验程序的错误带来了很大的方便。

### 程序并发执行

顺序执行时资源利用率很低，所以在系统中引入多道程序技术，使程序或程序段之间可以并发执行。**只有在不存在前趋关系的程序之间才有可能并发执行，否则无法并发执行。**

### 程序并发执行的特征

引入并发执行功能，虽然提高了系统的吞吐量和资源利用率，但是由于它们共享系统资源，为完成某些任务相互合作，致使并发执行的程序间形成相互制约的关系。

- **间断性：** 由于并发执行共享系统资源，它们完成同一个任务而相互合作，这些并发执行的程序之间就会形成相互制约关系。
- **失去封闭性：** 程序执行时，环境受其它程序影响(系统资源共享)
- **不可再现性：** 由于失去了封闭性，导致其失去了可再现性。结果和并发程序的执行速度有关。

### 进程的定义

为了能使得程序并发执行，并且可以对并发执行的程序加以描述和控制，就引入了**进程**的概念。

系统利用PCB(进程控制块)来描述进程的情况和活动过程，进而控制和管理进程。由**程序段、相关的数据段和PCB**三部分构成了**进程实体**。 进程实体我们简称为进程。

**创建进程就是创建进程实体中的PCB，撤销进程就是撤销进程的PCB**。

定义：

- 进程是程序的一次执行
- 进程是一个程序及其数据在处理机上顺序执行时发生的活动
- 进程是具有独立功能的程序在一个数据集合上运行的过程，它是系统进行资源分配和调度的一个独立单位。

### 进程的特征

- **动态性：** 动态性是进程的**最基本**特征。由创建而产生，由调度而执行，由撤销而消亡，进程实体具有生命周期。
- **并发性：**多个进程实体同存于内存中，能在一段时间内同时运行。并发性是**进程的重要特征和OS的重要特征**。没有建立PCB的程序时不能参与并发执行的。
- **独立性：**进程实体是一个能独立运行、独立获得资源和独立接受调度的基本单位。
- **异步性：** 进程按照异步方式运行，各自以独立、不可预知的速度向前推进。

### 进程的基本状态

每一个进程在生命周期中至少应处于以下三种基本状态之一：

- **就绪状态：**进程处于准备好运行的状态，即进程已分配到除CPU以外的所有必要资源后，只要再获得CPU，就能立刻执行。如果系统中有许多处于就绪状态的进程，通常将它们按一定的策略(如优先级策略)排成一个就绪队列。
- **执行状态：**进程已获得CPU，其程序正在执行的状态。对任何一个时刻，在单处理机系统中，只有一个进程处于执行状态，而在多处理机系统中，则有多个进程处于执行状态。
- **阻塞状态：**正在执行的进程由于发生某事件(如IO 请求、申请缓冲区失败等)暂时无法继续执行，即进程的执行受到阻塞。此时引起进程调度，OS把处理机分配给另一个就绪进程，而让受阻进程处于暂停状态，一般将这种暂停状态称为阻塞状态。通常系统将处于阻塞状态的进程排成一个阻塞队列。

### 进程状态转换

进程在运行时进程可以发生状态的改变

#### 三状态转换

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/41f093eb226045b9b0e4f44651a4cf63~tplv-k3u1fbpfcp-watermark.image)

#### 五状态转换

在三状态转换图中增加了**创建状态**和**终止状态**

- **创建状态：**进程申请一个空白PCB，向PCB中填写控制和管理进程的信息。然后为该进程分配运行时所必须的资源;最后，把该进程转入就绪状态并插入就绪队列之中。但如果进程所需的资源尚不能得到满足(如内存不够)，此时创建工作尚未完成，进程不能被调度运行，就把此时进程所处的状态称为创建状态。
- **终止状态：**等待操作系统进行善后处理，最后将其PCB清零，并将PCB空间返还系统。

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea4823bd13b24154949d4915940aff79~tplv-k3u1fbpfcp-watermark.image)

### 挂起操作和进程状态转换

当挂起操作作用于某个进程时，进程将被挂起，此时该进程处于静止状态。如果进程正在执行，它将暂停执行。若原本处于就绪状态，则该进程此时暂不接受调度。与挂起操作对应的操作是激活操作。
在引入**挂起原语Suspend**和**激活原语Active**后，在它们的作用下进程将可能发生以下几种状态的转换:

- **活动就绪→静止就绪：**当进程处于未被挂起的就绪状态时，称此为活动就绪状态，表示为Readya，此时进程可以接受调度。当用挂起原语Suspend将该进程挂起后，该进程便转变为静止就绪状态，表示为Readys，处于Readys状态的进程不再被调度执行。
- **活动阻塞→静止阻塞：**当进程处于未被挂起的阻塞状态时，称它是处于活动阻塞状态，表示为 Blockeda。当用Suspend原语将它挂起后，进程便转变为静止阻塞状态，表示为 Blockeds。处于该状态的进程在其所期待的事件出现后，它将从静止阻塞变为静止就绪Readys状态。
- **静止就绪→活动就绪：**处于Readys状态的进程若用激活原语Active激活后，该进程将转变为Readya状态。
- **静止阻塞→活动阻塞：**处于Blockeds状态的进程若用激活原语Active激活后，进程将转变为Blockeda状态。图2-7示出了具有挂起状态的进程状态图。

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3441f1530d7d4c4fb7d3e3db0809a433~tplv-k3u1fbpfcp-watermark.image)

### 进程控制块PCB

#### 作用

进程控制块PCB(Process Control Block)。PCB作为进程实体的一部分，记录了操作系统所需的，用于描述进程的当前情况以及管理进程运行的全部信息，是操作系统中最重要的记录型数据结构。

- 作为独立运行基本单位的标志
- 能实现间断性运行方式
- 提供进程管理所需要的信息
- 提供进程调度所需要的信息
- 实现和其它进程的同步与通信

#### PCB中存储的信息

- 进程标识符：唯一地标识一个进程
- 处理及状态
- 进程调度信息
- 进程控制信息

#### PCB的组织方式

- 线性方式：实现简单、开销小，但是每次查找都需要扫描整张线性表

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/86de95893f5a4967848fa4fb8a9c3747~tplv-k3u1fbpfcp-watermark.image)

- 链接方式：可以形成就绪队列、若干个阻塞队列、空白队列等。

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f210d4fc71da43299f88b22e417029b0~tplv-k3u1fbpfcp-watermark.image)

- 索引方式

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8cc7a5585228404bbc631d81997adaa2~tplv-k3u1fbpfcp-watermark.image)

### 进程控制

包括创建新进程、终止已完成的进程、将因发生异常情况而无法继续运行的进程置为阻塞状态，负责进程运行中的状态转换等功能。**进程控制一般是由OS内核中的原语控制的。**

#### 操作系统内核

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3917750d3fc46efb8af15f4b85a5f27~tplv-k3u1fbpfcp-watermark.image)